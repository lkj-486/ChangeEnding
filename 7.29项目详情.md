# æ•…äº‹ç¼–ç»‡è€… (StoryWeaver) ä»£ç åº“ç®€æŠ¥æ–‡æ¡£

**ç‰ˆæœ¬ï¼š** v2.0.0
**æ›´æ–°æ—¶é—´ï¼š** 2025å¹´7æœˆ29æ—¥
**æ–‡æ¡£ç±»å‹ï¼š** ä»£ç åº“ç®€æŠ¥ (Codebase Briefing Document)
**ç›®æ ‡è¯»è€…ï¼š** å¼€å‘è€…ã€AIåŠ©æ‰‹ã€æŠ€æœ¯å†³ç­–è€…

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£æ˜¯æ•…äº‹ç¼–ç»‡è€…é¡¹ç›®çš„æŠ€æœ¯è“å›¾ï¼Œæ—¨åœ¨ä¸ºä»»ä½•å¼€å‘è€…ï¼ˆåŒ…æ‹¬AIåŠ©æ‰‹ï¼‰æä¾›å¿«é€Ÿç†è§£é¡¹ç›®æ ¸å¿ƒæ¶æ„å’Œå®ç°é€»è¾‘çš„ç»“æ„åŒ–æŒ‡å—ã€‚é€šè¿‡é˜…è¯»æœ¬æ–‡æ¡£ï¼Œæ‚¨å¯ä»¥åœ¨5-10åˆ†é’Ÿå†…æŒæ¡æ•´ä¸ªé¡¹ç›®çš„æŠ€æœ¯æ¶æ„å’Œå®ç°ç»†èŠ‚ã€‚

## ğŸ¯ é¡¹ç›®æ ¸å¿ƒç†å¿µ

æ•…äº‹ç¼–ç»‡è€…æ˜¯ä¸€ä¸ªåŸºäºAIçš„äº’åŠ¨å™äº‹æ¸¸æˆï¼Œå®ç°äº†"AIè‡ªä¸»å™äº‹ä¸ç©å®¶å…³é”®å†³ç­–ç›¸ç»“åˆ"çš„åˆ›æ–°ç©æ³•ã€‚é¡¹ç›®é‡‡ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œé€šè¿‡"ç¼–æ’å™¨-ä»£ç†"æ¨¡å¼å®ç°AIé©±åŠ¨çš„åŠ¨æ€å™äº‹ç”Ÿæˆã€‚

**æ ¸å¿ƒç©æ³•é—­ç¯ï¼š**
```
AIè‡ªä¸»å™äº‹ â†’ å…³é”®èŠ‚ç‚¹ â†’ ç©å®¶ä»‹å…¥ â†’ æ•…äº‹åˆ†æ”¯ â†’ AIç»§ç»­å™äº‹
```

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    %% å‰ç«¯å±‚ (Frontend Layer)
    subgraph "å‰ç«¯å±‚ (Frontend)"
        App[App.tsx<br/>åº”ç”¨å…¥å£]
        GameScreen[GameScreen.tsx<br/>ä¸»æ¸¸æˆç•Œé¢]
        NarrativeRenderer[NarrativeRenderer<br/>å™äº‹æ¸²æŸ“å™¨]
        ChoiceManager[ChoiceManager<br/>é€‰æ‹©ç®¡ç†å™¨]

        %% çŠ¶æ€ç®¡ç†
        GameStore[gameStore.ts<br/>ZustandçŠ¶æ€ç®¡ç†<br/>- gamePhase<br/>- narrativeSegments<br/>- currentChoicePoint]

        %% é€šä¿¡å±‚
        WebSocketHook[useWebSocket.ts<br/>WebSocketé€šä¿¡Hook<br/>- è¿æ¥ç®¡ç†<br/>- äº‹ä»¶ç›‘å¬<br/>- çŠ¶æ€åŒæ­¥]
    end

    %% é€šä¿¡å±‚ (Communication Layer)
    subgraph "é€šä¿¡å±‚ (Communication)"
        WebSocket[Socket.IO<br/>å®æ—¶åŒå‘é€šä¿¡<br/>- narrative-update<br/>- choice-required<br/>- player-choice]
        RestAPI[REST API<br/>HTTPè¯·æ±‚<br/>- æ¸¸æˆåˆ›å»º<br/>- æ•…äº‹åˆ—è¡¨]
    end

    %% åç«¯å±‚ (Backend Layer)
    subgraph "åç«¯å±‚ (Backend)"
        GameController[GameController.ts<br/>æ¸¸æˆæ§åˆ¶å™¨<br/>- æ¸¸æˆä¼šè¯ç®¡ç†<br/>- WebSocketäº‹ä»¶å¤„ç†]

        PlayerHandler[PlayerInterventionHandler<br/>ç©å®¶ä»‹å…¥å¤„ç†å™¨<br/>- é€‰æ‹©ç‚¹è§¦å‘<br/>- ç©å®¶å†³ç­–å¤„ç†]
    end

    %% æ ¸å¿ƒå¼•æ“å±‚ (Core Engine Layer)
    subgraph "æ ¸å¿ƒå¼•æ“å±‚ (Core Engine)"
        Director[Director.ts<br/>æ¸¸æˆå¯¼æ¼”<br/>- åœºæ™¯æ§åˆ¶<br/>- äº‹ä»¶ç¼–æ’<br/>- AIä»£ç†è°ƒåº¦]

        EventBus[EventBus<br/>äº‹ä»¶æ€»çº¿<br/>- AI_ACTION_PROPOSED<br/>- NARRATIVE_READY<br/>- PLAYER_CHOICE_MADE]

        WorldState[WorldState.ts<br/>ECSä¸–ç•ŒçŠ¶æ€<br/>- å®ä½“ç®¡ç†<br/>- ç»„ä»¶ç³»ç»Ÿ<br/>- åœºæ™¯çŠ¶æ€]

        AIAgent[AIAgent.ts<br/>AIä»£ç†ç³»ç»Ÿ<br/>- è§’è‰²è¡Œä¸º<br/>- æ™ºèƒ½å†³ç­–<br/>- åŠ¨ä½œç”Ÿæˆ]

        NarrativeAgent[NarrativeAgent<br/>å™äº‹ä»£ç†<br/>- å†…å®¹ç”Ÿæˆ<br/>- æ–‡å­¦åŒ–å¤„ç†]
    end

    %% æ•°æ®æµå‘ (Data Flow)
    App --> GameScreen
    GameScreen --> NarrativeRenderer
    GameScreen --> ChoiceManager
    GameScreen --> GameStore
    GameScreen --> WebSocketHook

    WebSocketHook --> GameStore
    WebSocketHook --> WebSocket
    GameStore --> RestAPI

    WebSocket --> GameController
    RestAPI --> GameController
    GameController --> PlayerHandler
    GameController --> Director

    Director --> EventBus
    Director --> WorldState
    Director --> AIAgent
    EventBus --> NarrativeAgent
    EventBus --> PlayerHandler

    %% åå‘æ•°æ®æµ
    AIAgent --> EventBus
    NarrativeAgent --> EventBus
    EventBus --> Director
    Director --> GameController
    GameController --> WebSocket

    %% æ ·å¼å®šä¹‰
    classDef frontend fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef communication fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef backend fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef core fill:#fff3e0,stroke:#e65100,stroke-width:2px

    class App,GameScreen,NarrativeRenderer,ChoiceManager,GameStore,WebSocketHook frontend
    class WebSocket,RestAPI communication
    class GameController,PlayerHandler backend
    class Director,EventBus,WorldState,AIAgent,NarrativeAgent core
```

---

## ğŸ“ é¡¹ç›®æ–‡ä»¶ç»“æ„æ ‘

```
æ•…äº‹ç¼–ç»‡è€… (StoryWeaver) é¡¹ç›®ç»“æ„
â”œâ”€â”€ ğŸ“ packages/                          # Monorepoå·¥ä½œç©ºé—´
â”‚   â”œâ”€â”€ ğŸ“ core/                          # ğŸ® æ ¸å¿ƒæ¸¸æˆå¼•æ“ (95%å®Œæˆ)
â”‚   â”‚   â”œâ”€â”€ ğŸ“ src/                       # TypeScriptæºç 
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ index.ts              # æ ¸å¿ƒå¼•æ“ç»Ÿä¸€å¯¼å‡ºå…¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ types/                # ç±»å‹å®šä¹‰é›†åˆ
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ index.ts          # æ ¸å¿ƒæ•°æ®ç»“æ„ç±»å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ world/                # ECSä¸–ç•ŒçŠ¶æ€ç³»ç»Ÿ
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ WorldState.ts     # å®ä½“ç»„ä»¶ç³»ç»Ÿç®¡ç†å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ events/               # äº‹ä»¶é©±åŠ¨æ¶æ„
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ EventBus.ts       # å…¨å±€äº‹ä»¶æ€»çº¿
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ director/             # æ¸¸æˆæµç¨‹æ§åˆ¶
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ Director.ts       # æ¸¸æˆå¯¼æ¼” - æ ¸å¿ƒç¼–æ’å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ agents/               # AIä»£ç†ç³»ç»Ÿ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ AIAgent.ts        # AIä»£ç†åŸºç¡€æ¡†æ¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ NarrativeAgent.ts # å™äº‹å†…å®¹ç”Ÿæˆä»£ç†
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ StubAgentCore.ts  # AIæ¥å£å­˜æ ¹å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ handlers/             # äº‹ä»¶å¤„ç†å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ PlayerInterventionHandler.ts # ç©å®¶ä»‹å…¥å¤„ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ services/             # å¤–éƒ¨æœåŠ¡é›†æˆ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LLMService.ts     # LLMæœåŠ¡æŠ½è±¡å±‚
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“ adapters/         # æœåŠ¡é€‚é…å™¨
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ ğŸ“„ MockLLMAdapter.ts # Mock LLMé€‚é…å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ scenes/               # åœºæ™¯ç®¡ç†
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ SceneLoader.ts    # åœºæ™¯æ•°æ®åŠ è½½å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ interfaces/           # æ¥å£å®šä¹‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ AgentCoreInterface.ts # AIæ ¸å¿ƒæ¥å£è§„èŒƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ config/               # é…ç½®ç®¡ç†
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ConfigManager.ts  # é…ç½®ç®¡ç†å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ constants.ts      # ç³»ç»Ÿå¸¸é‡å®šä¹‰
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“ utils/                # å·¥å…·å‡½æ•°
â”‚   â”‚   â”‚       â””â”€â”€ ğŸ“„ ErrorHandler.ts   # é”™è¯¯å¤„ç†æœºåˆ¶
â”‚   â”‚   â”œâ”€â”€ ğŸ“ dist/                     # TypeScriptç¼–è¯‘è¾“å‡º
â”‚   â”‚   â”œâ”€â”€ ğŸ“ data/                     # æ¸¸æˆæ•°æ®æ–‡ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ scenes/               # åœºæ™¯å®šä¹‰JSON
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“ characters/           # è§’è‰²å®šä¹‰JSON
â”‚   â”‚   â””â”€â”€ ğŸ“„ package.json              # æ ¸å¿ƒåŒ…é…ç½®
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ api/                          # ğŸŒ åç«¯APIæœåŠ¡ (90%å®Œæˆ)
â”‚   â”‚   â”œâ”€â”€ ğŸ“ src/                      # Express.jsåº”ç”¨æºç 
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ index.ts              # æœåŠ¡å™¨å¯åŠ¨å…¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ app.ts                # Expressåº”ç”¨é…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ controllers/          # æ§åˆ¶å™¨å±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GameController.ts # æ¸¸æˆé€»è¾‘æ§åˆ¶å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ StoryController.ts # æ•…äº‹ç®¡ç†æ§åˆ¶å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ routes/               # è·¯ç”±å®šä¹‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ index.ts          # è·¯ç”±æ±‡æ€»
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ game.ts           # æ¸¸æˆç›¸å…³è·¯ç”±
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ story.ts          # æ•…äº‹ç›¸å…³è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ services/             # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ middleware/           # ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“ config/               # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ ğŸ“ prisma/                   # æ•°æ®åº“ORM
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ schema.prisma         # æ•°æ®åº“æ¨¡å¼å®šä¹‰
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ seed.ts               # æ•°æ®åº“ç§å­æ•°æ®
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ test-server.js            # ä¸´æ—¶æµ‹è¯•æœåŠ¡å™¨
â”‚   â”‚   â””â”€â”€ ğŸ“„ package.json              # APIåŒ…é…ç½®
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“ web/                          # ğŸ¨ å‰ç«¯Reactåº”ç”¨ (95%å®Œæˆ)
â”‚       â”œâ”€â”€ ğŸ“ src/                      # Reactåº”ç”¨æºç 
â”‚       â”‚   â”œâ”€â”€ ğŸ“„ main.tsx              # Reactåº”ç”¨å…¥å£
â”‚       â”‚   â”œâ”€â”€ ğŸ“„ App.tsx               # æ ¹ç»„ä»¶ - åº”ç”¨è·¯ç”±
â”‚       â”‚   â”œâ”€â”€ ğŸ“„ index.css             # å…¨å±€æ ·å¼å…¥å£
â”‚       â”‚   â”œâ”€â”€ ğŸ“ components/           # Reactç»„ä»¶
â”‚       â”‚   â”‚   â”œâ”€â”€ ğŸ“ GameScreen/       # æ¸¸æˆä¸»ç•Œé¢ç»„ä»¶
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GameScreen.tsx # æ¸¸æˆä¸»ç•Œé¢å®¹å™¨
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ NarrativeRenderer.tsx # å™äº‹å†…å®¹æ¸²æŸ“å™¨
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ChoiceManager.tsx # é€‰æ‹©ç®¡ç†å™¨
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ StateDisplay.tsx # çŠ¶æ€æ˜¾ç¤ºå™¨
â”‚       â”‚   â”‚   â””â”€â”€ ğŸ“„ ErrorBoundary.tsx # é”™è¯¯è¾¹ç•Œç»„ä»¶
â”‚       â”‚   â”œâ”€â”€ ğŸ“ stores/               # çŠ¶æ€ç®¡ç†
â”‚       â”‚   â”‚   â””â”€â”€ ğŸ“„ gameStore.ts      # Zustandæ¸¸æˆçŠ¶æ€ç®¡ç†
â”‚       â”‚   â”œâ”€â”€ ğŸ“ hooks/                # è‡ªå®šä¹‰Hooks
â”‚       â”‚   â”‚   â””â”€â”€ ğŸ“„ useWebSocket.ts   # WebSocketé€šä¿¡Hook
â”‚       â”‚   â”œâ”€â”€ ğŸ“ services/             # æœåŠ¡å±‚
â”‚       â”‚   â”‚   â””â”€â”€ ğŸ“„ api.ts            # APIå®¢æˆ·ç«¯å°è£…
â”‚       â”‚   â”œâ”€â”€ ğŸ“ types/                # å‰ç«¯ç±»å‹å®šä¹‰
â”‚       â”‚   â”‚   â””â”€â”€ ğŸ“„ game.ts           # æ¸¸æˆç›¸å…³ç±»å‹
â”‚       â”‚   â””â”€â”€ ğŸ“ styles/               # æ ·å¼æ–‡ä»¶
â”‚       â”‚       â””â”€â”€ ğŸ“„ base.css          # åŸºç¡€æ ·å¼å®šä¹‰
â”‚       â”œâ”€â”€ ğŸ“„ index.html                # HTMLæ¨¡æ¿
â”‚       â”œâ”€â”€ ğŸ“„ vite.config.ts            # Viteæ„å»ºé…ç½®
â”‚       â””â”€â”€ ğŸ“„ package.json              # å‰ç«¯åŒ…é…ç½®
â”‚
â”œâ”€â”€ ğŸ“ scripts/                          # ğŸ”§ è‡ªåŠ¨åŒ–è„šæœ¬
â”‚   â”œâ”€â”€ ğŸ“„ setup.js                      # ç¯å¢ƒè‡ªåŠ¨åŒ–è®¾ç½®è„šæœ¬
â”‚   â”œâ”€â”€ ğŸ“„ dev-parallel.js               # å¹¶è¡Œå¼€å‘æœåŠ¡å¯åŠ¨
â”‚   â””â”€â”€ ğŸ“„ utils.js                      # è„šæœ¬å·¥å…·å‡½æ•°é›†åˆ
â”‚
â”œâ”€â”€ ğŸ“ .augment/                         # ğŸ¤– AIåŠ©æ‰‹é…ç½®
â”‚   â””â”€â”€ ğŸ“ rules/                        # å¼€å‘è§„åˆ™æ–‡æ¡£
â”‚       â”œâ”€â”€ ğŸ“„ rule.md                   # ä»£ç ä¿®æ”¹æ³¨æ„äº‹é¡¹
â”‚       â””â”€â”€ ğŸ“„ å¼€å‘æ–‡æ¡£.md                # é¡¹ç›®å¼€å‘æŒ‡å¯¼æ–‡æ¡£
â”‚
â”œâ”€â”€ ğŸ“„ package.json                      # Monorepoæ ¹é…ç½®
â”œâ”€â”€ ğŸ“„ turbo.json                        # Turborepoæ„å»ºé…ç½®
â”œâ”€â”€ ğŸ“„ pnpm-workspace.yaml               # pnpmå·¥ä½œç©ºé—´é…ç½®
â”œâ”€â”€ ğŸ“„ docker-compose.yml                # Dockerå¼€å‘ç¯å¢ƒ
â”œâ”€â”€ ğŸ“„ .env.development                  # å¼€å‘ç¯å¢ƒå˜é‡
â”œâ”€â”€ ğŸ“„ README.md                         # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ ğŸ“„ PROJECT_STATUS.md                 # é¡¹ç›®çŠ¶æ€æŠ¥å‘Š
â””â”€â”€ ğŸ“„ 7.29é¡¹ç›®è¯¦æƒ….md                   # é¡¹ç›®è¯¦æƒ…æ–‡æ¡£
```

---

## ğŸ” æ ¸å¿ƒæ–‡ä»¶ä»£ç æ‘˜è¦

### 1. Director.ts - æ¸¸æˆæµç¨‹æ§åˆ¶æ ¸å¿ƒ

**æ ¸å¿ƒèŒè´£ï¼š** æ¸¸æˆå¯¼æ¼”å’Œç¼–æ’å™¨ï¼Œè´Ÿè´£åœºæ™¯ç®¡ç†ã€AIä»£ç†è°ƒåº¦å’Œäº‹ä»¶ç¼–æ’

**å…³é”®ç»„ä»¶/é€»è¾‘ï¼š**
- `Director` ç±»ï¼šä¸»è¦çš„æ¸¸æˆæµç¨‹æ§åˆ¶å™¨
- `setupEventListeners()`ï¼šè®¾ç½®äº‹ä»¶é©±åŠ¨æ¶æ„ç›‘å¬å™¨
- `handleProposedAction()`ï¼šå¤„ç†AIä»£ç†æå‡ºçš„åŠ¨ä½œ
- `triggerAIOrchestration()`ï¼šAIé©±åŠ¨çš„ç¼–æ’å¾ªç¯
- `tick()`ï¼šæ¸¸æˆä¸»æ—¶é’Ÿï¼Œæ¯ä¸ªtickæ£€æŸ¥å¹¶è°ƒåº¦AIä»£ç†
- é€‰æ‹©ç‚¹çŠ¶æ€é”æœºåˆ¶ï¼šé˜²æ­¢é‡å¤è§¦å‘é€‰æ‹©ç‚¹

**è¾“å…¥/è¾“å‡ºï¼š**
- è¾“å…¥ï¼šWorldStateå®ä¾‹ã€AgentCoreInterfaceã€åœºæ™¯æ•°æ®
- è¾“å‡ºï¼šé€šè¿‡EventBuså‘å¸ƒNARRATIVE_READYã€CHOICE_POINT_RAISEDç­‰äº‹ä»¶

**ä¸»è¦ä¾èµ–ï¼š**
- `EventBus`ï¼šäº‹ä»¶é€šä¿¡
- `WorldState`ï¼šECSä¸–ç•ŒçŠ¶æ€ç®¡ç†
- `AgentCoreInterface`ï¼šAIæ ¸å¿ƒæ¥å£
- `PlayerInterventionHandler`ï¼šç©å®¶ä»‹å…¥å¤„ç†

### 2. AIAgent.ts - AIä»£ç†ç³»ç»ŸåŸºç¡€

**æ ¸å¿ƒèŒè´£ï¼š** é€šç”¨AIè§’è‰²ä»£ç†ï¼Œæ¥æ”¶å¯¼æ¼”æŒ‡ä»¤å¹¶åŸºäºè§’è‰²è®¾å®šè§„åˆ’åŠ¨ä½œ

**å…³é”®ç»„ä»¶/é€»è¾‘ï¼š**
- `AIAgent` ç±»ï¼šAIä»£ç†çš„åŸºç¡€å®ç°
- `respondToDirectorRequest()`ï¼šå“åº”å¯¼æ¼”çš„è¡ŒåŠ¨è¯·æ±‚
- `planNextAction()`ï¼šåŸºäºä¸Šä¸‹æ–‡çš„æ™ºèƒ½å†³ç­–
- `determineCurrentGoal()`ï¼šåŸºäºå™äº‹ä¸Šä¸‹æ–‡ç¡®å®šå½“å‰ç›®æ ‡
- `checkActionDiversity()`ï¼šæ£€æŸ¥åŠ¨ä½œå¤šæ ·æ€§
- åŠ¨ä½œå†å²å’Œç›®æ ‡ç³»ç»Ÿï¼šè¿½è¸ªä»£ç†è¡Œä¸ºæ¨¡å¼

**è¾“å…¥/è¾“å‡ºï¼š**
- è¾“å…¥ï¼šAIAgentConfigé…ç½®ã€NarrativeLedgerå™äº‹è´¦æœ¬
- è¾“å‡ºï¼šé€šè¿‡EventBuså‘å¸ƒAI_ACTION_PROPOSEDäº‹ä»¶

**ä¸»è¦ä¾èµ–ï¼š**
- `LLMService`ï¼šè¯­è¨€æ¨¡å‹æœåŠ¡
- `EventBus`ï¼šäº‹ä»¶é€šä¿¡
- `Character`ã€`GoalComponent`ã€`PersonalityComponent`ï¼šè§’è‰²ç›¸å…³ç±»å‹

### 3. gameStore.ts - å‰ç«¯çŠ¶æ€ç®¡ç†ä¸­å¿ƒ

**æ ¸å¿ƒèŒè´£ï¼š** ZustandçŠ¶æ€ç®¡ç†ï¼Œä½œä¸ºå‰ç«¯æ¸¸æˆçŠ¶æ€çš„å”¯ä¸€äº‹å®æ¥æº

**å…³é”®ç»„ä»¶/é€»è¾‘ï¼š**
- `GameState` æ¥å£ï¼šå®šä¹‰å®Œæ•´çš„æ¸¸æˆçŠ¶æ€ç»“æ„
- `useGameStore` Hookï¼šZustandçŠ¶æ€ç®¡ç†å®ä¾‹
- `startGame()`ï¼šæ¸¸æˆå¯åŠ¨é€»è¾‘
- `addNarrativeSegment()`ï¼šæ·»åŠ å™äº‹å†…å®¹ï¼ˆæ”¯æŒçŠ¶æ€ä¸€è‡´æ€§ï¼‰
- `setChoicePoint()`ï¼šè®¾ç½®é€‰æ‹©ç‚¹çŠ¶æ€
- `submitChoice()`ï¼šæäº¤ç©å®¶é€‰æ‹©

**è¾“å…¥/è¾“å‡ºï¼š**
- è¾“å…¥ï¼šWebSocketäº‹ä»¶ã€APIå“åº”ã€ç”¨æˆ·äº¤äº’
- è¾“å‡ºï¼šReactç»„ä»¶çŠ¶æ€ã€APIè¯·æ±‚

**ä¸»è¦ä¾èµ–ï¼š**
- `zustand`ï¼šçŠ¶æ€ç®¡ç†åº“
- `apiClient`ï¼šAPIå®¢æˆ·ç«¯æœåŠ¡
- `NarrativeSegment`ã€`ChoicePoint`ï¼šæ¸¸æˆæ•°æ®ç±»å‹

### 4. useWebSocket.ts - å®æ—¶é€šä¿¡ç®¡ç†

**æ ¸å¿ƒèŒè´£ï¼š** WebSocketè¿æ¥ç®¡ç†å’Œå®æ—¶äº‹ä»¶å¤„ç†Hook

**å…³é”®ç»„ä»¶/é€»è¾‘ï¼š**
- `useWebSocket` Hookï¼šWebSocketè¿æ¥ç®¡ç†
- `createConnection()`ï¼šåˆ›å»ºWebSocketè¿æ¥
- `manualReconnect()`ï¼šæ‰‹åŠ¨é‡è¿æœºåˆ¶
- äº‹ä»¶ç›‘å¬å™¨ï¼šå¤„ç†narrative-updateã€choice-requiredç­‰äº‹ä»¶
- è¿æ¥çŠ¶æ€ç®¡ç†ï¼šconnectingã€connectedã€disconnectedã€reconnecting

**è¾“å…¥/è¾“å‡ºï¼š**
- è¾“å…¥ï¼šgameIdã€WebSocketæœåŠ¡å™¨äº‹ä»¶
- è¾“å‡ºï¼šè¿æ¥çŠ¶æ€ã€é”™è¯¯ä¿¡æ¯ã€è§¦å‘gameStoreçŠ¶æ€æ›´æ–°

**ä¸»è¦ä¾èµ–ï¼š**
- `socket.io-client`ï¼šWebSocketå®¢æˆ·ç«¯
- `useGameStore`ï¼šçŠ¶æ€ç®¡ç†
- React Hooksï¼šuseEffectã€useStateã€useCallback

### 5. GameScreen.tsx - ä¸»æ¸¸æˆç•Œé¢

**æ ¸å¿ƒèŒè´£ï¼š** ä¸»æ¸¸æˆç•Œé¢ç»„ä»¶ï¼Œè´Ÿè´£åŒæ å¸ƒå±€å’Œæ•´ä½“æ¸¸æˆç•Œé¢ç®¡ç†

**å…³é”®ç»„ä»¶/é€»è¾‘ï¼š**
- `GameScreen` ç»„ä»¶ï¼šä¸»æ¸¸æˆç•Œé¢å®¹å™¨
- åŒæ å¸ƒå±€ï¼š70%æ•…äº‹åŒºåŸŸ + 30%äº¤äº’é¢æ¿
- çŠ¶æ€é›†æˆï¼šä»gameStoreè·å–æ‰€æœ‰æ¸¸æˆçŠ¶æ€
- å­ç»„ä»¶ç®¡ç†ï¼šNarrativeRendererã€ChoiceManagerã€StateDisplay
- å“åº”å¼è®¾è®¡ï¼šæ¡Œé¢ä¼˜å…ˆï¼Œç§»åŠ¨ç«¯è‡ªé€‚åº”

**è¾“å…¥/è¾“å‡ºï¼š**
- è¾“å…¥ï¼šgameId propã€gameStoreçŠ¶æ€ã€WebSocketè¿æ¥çŠ¶æ€
- è¾“å‡ºï¼šæ¸²æŸ“å®Œæ•´çš„æ¸¸æˆç•Œé¢

**ä¸»è¦ä¾èµ–ï¼š**
- `useGameStore`ï¼šæ¸¸æˆçŠ¶æ€ç®¡ç†
- `useWebSocket`ï¼šå®æ—¶é€šä¿¡
- `NarrativeRenderer`ã€`ChoiceManager`ã€`StateDisplay`ï¼šå­ç»„ä»¶

### 6. GameController.ts - åç«¯æ¸¸æˆé€»è¾‘æ§åˆ¶

**æ ¸å¿ƒèŒè´£ï¼š** åç«¯æ¸¸æˆæ§åˆ¶å™¨ï¼Œå¤„ç†HTTPè¯·æ±‚å’ŒWebSocketäº‹ä»¶

**å…³é”®ç»„ä»¶/é€»è¾‘ï¼š**
- `GameController` ç±»ï¼šæ¸¸æˆHTTPè¯·æ±‚å¤„ç†
- `GameInstance` ç±»ï¼šå•ä¸ªæ¸¸æˆä¼šè¯ç®¡ç†
- `createNewGame()`ï¼šåˆ›å»ºæ–°æ¸¸æˆä¼šè¯
- `makeChoice()`ï¼šå¤„ç†ç©å®¶é€‰æ‹©
- `setupWebSocket()`ï¼šè®¾ç½®WebSocketäº‹ä»¶ç›‘å¬
- äº‹ä»¶è½¬å‘ï¼šå°†æ ¸å¿ƒå¼•æ“äº‹ä»¶è½¬å‘ç»™å‰ç«¯

**è¾“å…¥/è¾“å‡ºï¼š**
- è¾“å…¥ï¼šHTTPè¯·æ±‚ã€WebSocketè¿æ¥ã€æ ¸å¿ƒå¼•æ“äº‹ä»¶
- è¾“å‡ºï¼šHTTPå“åº”ã€WebSocketäº‹ä»¶ã€æ•°æ®åº“æ“ä½œ

**ä¸»è¦ä¾èµ–ï¼š**
- `Director`ï¼šæ¸¸æˆæµç¨‹æ§åˆ¶
- `WorldState`ï¼šECSä¸–ç•ŒçŠ¶æ€
- `AIAgent`ã€`NarrativeAgent`ï¼šAIä»£ç†ç³»ç»Ÿ


---

## ğŸ“Š å…³é”®ç±»å‹å®šä¹‰æ•°æ®å­—å…¸

### æ ¸å¿ƒæ•°æ®ç»“æ„ç±»å‹

#### NarrativeLedger - å™äº‹è´¦æœ¬ï¼ˆAIå†³ç­–çš„å”¯ä¸€äº‹å®æ¥æºï¼‰
```typescript
interface NarrativeLedger {
  playerCharacter: PlayerCharacter;           // ç©å®¶è§’è‰²ç”»åƒ
  characterRelationships: Record<string, CharacterRelationship>; // è§’è‰²å…³ç³»ç½‘ç»œ
  worldState: WorldState;                     // ä¸–ç•ŒçŠ¶æ€
  recentEvents: NarrativeEvent[];            // æœ€è¿‘çš„é‡è¦äº‹ä»¶
  characterGoals?: Record<string, GoalComponent>; // è§’è‰²ç›®æ ‡ä¿¡æ¯
  characterPersonalities?: Record<string, PersonalityComponent>; // è§’è‰²æ€§æ ¼ä¿¡æ¯
  version?: string;                          // è´¦æœ¬ç‰ˆæœ¬
  metadata?: {                               // å…ƒæ•°æ®
    game_session_id: string;
    story_id: string;
    created_at: number;
    last_updated: number;
  };
}
```

#### PlayerCharacter - ç©å®¶è§’è‰²ç”»åƒ
```typescript
interface PlayerCharacter {
  morality_vector: Record<string, number>;    // é“å¾·å‘é‡ (-1.0 åˆ° 1.0)
  methodology_preference: Record<string, number>; // è¡Œäº‹é£æ ¼åå¥½ (0-10)
  personality_traits: string[];              // æ€§æ ¼ç‰¹è´¨æ ‡ç­¾
  development_stage?: string;                // è§’è‰²å‘å±•é˜¶æ®µ
}
```

#### ChoicePoint - é€‰æ‹©ç‚¹æ•°æ®ç»“æ„
```typescript
interface ChoicePoint {
  choicePointId: string;                     // é€‰æ‹©ç‚¹å”¯ä¸€æ ‡è¯†
  options: ChoiceOption[];                   // å¯é€‰é€‰é¡¹åˆ—è¡¨
  context?: {                                // ä¸Šä¸‹æ–‡ä¿¡æ¯
    prompt?: string;                         // é€‰æ‹©æç¤º
    timeLimit?: number;                      // æ—¶é—´é™åˆ¶
    defaultChoice?: string;                  // é»˜è®¤é€‰æ‹©
  };
  metadata?: {                               // å…ƒæ•°æ®
    importance?: 'low' | 'medium' | 'high';  // é‡è¦æ€§çº§åˆ«
    category?: string;                       // é€‰æ‹©ç±»åˆ«
  };
}
```

#### NarrativeSegment - å™äº‹å†…å®¹é¡¹ç›®
```typescript
interface NarrativeSegment {
  id: string;                                // å†…å®¹å”¯ä¸€æ ‡è¯†
  type: 'dialogue' | 'narration' | 'introspection' | 'description'; // å†…å®¹ç±»å‹
  content: string | object;                  // å†…å®¹æ•°æ®
  character?: string;                        // è§’è‰²IDï¼ˆå¯¹è¯æ—¶ï¼‰
  timestamp: number;                         // æ—¶é—´æˆ³
  metadata?: {                               // å…ƒæ•°æ®
    style?: string;                          // æ–‡æœ¬é£æ ¼
    emotion?: string;                        // æƒ…æ„Ÿæ ‡ç­¾
    personalized?: boolean;                  // æ˜¯å¦ä¸ªæ€§åŒ–
    story_phase?: string;                    // æ•…äº‹é˜¶æ®µ
  };
}
```

### AIæ¥å£ç±»å‹

#### AgentCoreInterface - AIæ ¸å¿ƒæ¥å£
```typescript
interface AgentCoreInterface {
  decideNextStep(request: DecisionRequest): Promise<DecisionResponse>;
  generateContent(request: ContentRequest): Promise<ContentResponse>;
  getStatus(): Promise<AgentStatus>;
}
```

#### DecisionRequest/Response - AIå†³ç­–è¯·æ±‚/å“åº”
```typescript
interface DecisionRequest {
  ledger: NarrativeLedger;                   // å™äº‹è´¦æœ¬
  availableActions: ContentType[];           // å¯ç”¨åŠ¨ä½œç±»å‹
  context?: Record<string, any>;             // é¢å¤–ä¸Šä¸‹æ–‡
}

interface DecisionResponse {
  nextAction: ContentType;                   // ä¸‹ä¸€æ­¥åŠ¨ä½œç±»å‹
  context: Record<string, any>;              // ä¼ é€’ç»™ç”Ÿæˆå™¨çš„ä¸Šä¸‹æ–‡
  confidence?: number;                       // å†³ç­–ç½®ä¿¡åº¦
  reasoning?: string;                        // å†³ç­–ç†ç”±
}
```

### äº‹ä»¶è½½è·ç±»å‹

#### EventBusäº‹ä»¶ç±»å‹å®šä¹‰
```typescript
type Events = {
  // AIä»£ç†äº‹ä»¶
  REQUEST_AI_ACTION: {
    agentId: string;
    timestamp: number;
    context: { sceneId?: string; sceneState?: any; };
    narrativeLedger?: NarrativeLedger;
  };

  AI_ACTION_PROPOSED: {
    agentId: string;
    action: GameAction;
    timestamp: number;
  };

  // å™äº‹äº‹ä»¶
  NARRATIVE_READY: {
    segment: {
      id: string;
      type: 'narration' | 'dialogue' | 'introspection';
      content: string;
      character?: string;
      timestamp: number;
      metadata?: any;
    };
    timestamp: number;
  };

  // ç©å®¶é€‰æ‹©äº‹ä»¶
  PLAYER_CHOICE_MADE: {
    choicePointId: string;
    selectedOptionId: string;
    action: GameAction;
  };

  CHOICE_POINT_RAISED: {
    choicePointId: string;
    options: ChoiceOption[];
    context: any;
  };
};
```

### å‰ç«¯çŠ¶æ€ç±»å‹

#### GameState - å‰ç«¯æ¸¸æˆçŠ¶æ€
```typescript
interface GameState {
  // æ ¸å¿ƒæ¸¸æˆçŠ¶æ€
  gameId: string | null;
  storyId: string | null;
  isGameActive: boolean;
  isLoading: boolean;
  error: string | null;

  // æ¸¸æˆé˜¶æ®µç®¡ç†
  gamePhase: 'narrative' | 'decision';       // æ¸¸æˆé˜¶æ®µ
  narrativeSegments: NarrativeSegment[];     // å™äº‹å†…å®¹åˆ—è¡¨
  currentChoicePoint: ChoicePoint | null;    // å½“å‰é€‰æ‹©ç‚¹

  // åœºæ™¯çŠ¶æ€
  currentScene: any;

  // æ ¸å¿ƒåŠ¨ä½œæ–¹æ³•
  startGame: (storyId: string, userId?: string) => Promise<void>;
  endGame: () => void;
  addNarrativeSegment: (segment: NarrativeSegment) => void;
  setChoicePoint: (choicePoint: ChoicePoint | null) => void;
  submitChoice: (optionId: string) => Promise<void>;
}
```

### APIæ¥å£ç±»å‹

#### WebSocketäº‹ä»¶ç±»å‹
```typescript
interface WebSocketEvent {
  type: string;                              // äº‹ä»¶ç±»å‹
  gameId: string;                           // æ¸¸æˆID
  data: any;                                // äº‹ä»¶æ•°æ®
  timestamp: number;                        // æ—¶é—´æˆ³
}

// å…·ä½“äº‹ä»¶ç±»å‹
interface NarrativeUpdateEvent {
  segment: NarrativeSegment;
}

interface ChoiceRequiredEvent {
  choicePointId: string;
  options: ChoiceOption[];
  context: Record<string, any>;
  timestamp: number;
}
```

#### APIå“åº”ç±»å‹
```typescript
interface ApiResponse<T = any> {
  success: boolean;                          // è¯·æ±‚æ˜¯å¦æˆåŠŸ
  data?: T;                                 // å“åº”æ•°æ®
  error?: string;                           // é”™è¯¯ä¿¡æ¯
  message?: string;                         // å“åº”æ¶ˆæ¯
}

interface GameStateResponse {
  gameId: string;
  storyId: string;
  scene: { id: string; title: string; description: string; };
  narrative: NarrativeSegment[];
  currentChoice?: ChoicePoint;
  isWaitingForChoice: boolean;
  sceneState: SceneState;
}
```

---

## ğŸš€ æŠ€æœ¯äº®ç‚¹ä¸æ¶æ„ç‰¹è‰²

### äº‹ä»¶é©±åŠ¨æ¶æ„
- åŸºäºEventBusçš„æ¾è€¦åˆç»„ä»¶é€šä¿¡
- æ”¯æŒAI_ACTION_PROPOSEDã€NARRATIVE_READYã€PLAYER_CHOICE_MADEç­‰æ ‡å‡†äº‹ä»¶
- å®Œæ•´çš„äº‹ä»¶å†å²è®°å½•å’Œè°ƒè¯•æ”¯æŒ

### AIä»£ç†ç³»ç»Ÿ
- æ¨¡å—åŒ–çš„AIä»£ç†è®¾è®¡ï¼Œæ”¯æŒä¸åŒè§’è‰²å’Œè¡Œä¸ºæ¨¡å¼
- åŸºäºç›®æ ‡å¯¼å‘çš„æ™ºèƒ½å†³ç­–ç³»ç»Ÿ
- æ”¯æŒLLMæœåŠ¡çš„æŠ½è±¡å±‚ï¼Œå¯æ¥å…¥å¤šç§AIæœåŠ¡

### ECSæ¶æ„
- ä½¿ç”¨Geoticåº“å®ç°å®ä½“ç»„ä»¶ç³»ç»Ÿ
- æ”¯æŒPositionã€Identityã€GoalComponentã€PersonalityComponentç­‰ç»„ä»¶
- é«˜æ€§èƒ½çš„ä¸–ç•ŒçŠ¶æ€ç®¡ç†å’ŒæŸ¥è¯¢

### å®æ—¶é€šä¿¡
- Socket.IOåŒå‘é€šä¿¡ï¼Œæ”¯æŒæ¸¸æˆçŠ¶æ€åŒæ­¥
- è‡ªåŠ¨é‡è¿æœºåˆ¶å’Œè¿æ¥çŠ¶æ€ç®¡ç†
- WebSocketäº‹ä»¶çš„ç±»å‹å®‰å…¨å¤„ç†

### å“åº”å¼è®¾è®¡
- 70%æ•…äº‹åŒºåŸŸ + 30%äº¤äº’é¢æ¿çš„æœ€ä¼˜å¸ƒå±€
- CSSå˜é‡ç³»ç»Ÿæ”¯æŒä¸»é¢˜å®šåˆ¶
- æ¡Œé¢ä¼˜å…ˆçš„å“åº”å¼è®¾è®¡ç­–ç•¥

---

## ğŸ“ˆ é¡¹ç›®çŠ¶æ€æ€»ç»“

**æ•´ä½“å®Œæˆåº¦ï¼š** çº¦85%ï¼ˆæ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼Œç”Ÿäº§ç¯å¢ƒåŠŸèƒ½å¾…å®Œå–„ï¼‰

**å„æ¨¡å—çŠ¶æ€ï¼š**
- ğŸ® æ ¸å¿ƒå¼•æ“ï¼š95%å®Œæˆ - æ¶æ„å®Œæ•´ï¼ŒAIæ¥å£è§„èŒƒåŒ–
- ğŸŒ åç«¯APIï¼š90%å®Œæˆ - åŸºç¡€åŠŸèƒ½å®Œæ•´ï¼ŒWebSocketé€šä¿¡ç¨³å®š
- ğŸ¨ å‰ç«¯åº”ç”¨ï¼š95%å®Œæˆ - UIå®Œæ•´ï¼ŒçŠ¶æ€ç®¡ç†ä¼˜åŒ–
- ğŸ”§ å¼€å‘å·¥å…·ï¼š95%å®Œæˆ - Monorepoé…ç½®å®Œæ•´ï¼Œè‡ªåŠ¨åŒ–è„šæœ¬å¯ç”¨

**æŠ€æœ¯å€ºåŠ¡ï¼š**
- æ•°æ®æŒä¹…åŒ–ï¼šä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œéœ€è¦é›†æˆæ•°æ®åº“
- AIé›†æˆï¼šå½“å‰ä½¿ç”¨å­˜æ ¹å®ç°ï¼Œéœ€è¦æ¥å…¥çœŸå®LLMæœåŠ¡
- æµ‹è¯•è¦†ç›–ï¼šå•å…ƒæµ‹è¯•è¦†ç›–ç‡éœ€è¦æå‡
- ç”Ÿäº§ç¯å¢ƒï¼šéœ€è¦æ·»åŠ ç›‘æ§ã€æ—¥å¿—ã€å®‰å…¨æœºåˆ¶

**ä¸‹ä¸€æ­¥ä¼˜å…ˆçº§ï¼š**
1. é›†æˆçœŸå®çš„LLMæœåŠ¡ï¼ˆå¦‚OpenAIã€Claudeç­‰ï¼‰
2. å®ç°æ•°æ®æŒä¹…åŒ–å’Œç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
3. å¢åŠ æµ‹è¯•è¦†ç›–ç‡å’Œé”™è¯¯å¤„ç†æœºåˆ¶
4. ä¼˜åŒ–æ€§èƒ½å’Œæ·»åŠ ç”Ÿäº§ç¯å¢ƒåŠŸèƒ½

é¡¹ç›®å…·å¤‡ç»§ç»­å¼€å‘çš„è‰¯å¥½åŸºç¡€ï¼Œæ ¸å¿ƒæ¶æ„è®¾è®¡åˆç†ï¼Œå¯æ‰©å±•æ€§å¼ºã€‚
